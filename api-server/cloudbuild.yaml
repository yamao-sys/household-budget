substitutions:
  _REGION: 'asia-northeast1'
  _SERVIVE: 'api-server'
steps:
  # NOTE: APIコンテナのビルド・プッシュ
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'build',
        '-t',
        '$_REGION-docker.pkg.dev/${PROJECT_ID}/${_SERVIVE}/latest',
        '-f',
        'Dockerfile',
        '.',
      ]
    id: build-api-server
    waitFor: ['-']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '$_REGION-docker.pkg.dev/${PROJECT_ID}/${_SERVIVE}/latest']
    id: push-api-server-image
    waitFor: ['build-api-server']

  # NOTE: Cloud Run へデプロイ
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - -c
      - |
        gcloud run deploy ${_SERVIVE} \
          --image ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_SERVIVE}/latest \
          --project ${PROJECT_ID} \
          --platform managed \
          --region ${_REGION} \
          --update-env-vars="SERVICE_ACCOUNT_EMAIL=$$SERVICE_ACCOUNT_EMAIL,MYSQL_DBNAME=$$MYSQL_DBNAME,MYSQL_USER=$$MYSQL_USER,MYSQL_PASS=$$MYSQL_PASS,MYSQL_HOST=$$MYSQL_HOST,MYSQL_PORT=$$MYSQL_PORT,SERVER_PORT=$$SERVER_PORT,JWT_TOKEN_KEY=$$JWT_TOKEN_KEY,CLIENT_ORIGIN=$$CLIENT_ORIGIN,APP_ENV=$$APP_ENV" \
          --service-account="$$SERVICE_ACCOUNT_EMAIL"
    id: deploy-api-server
    waitFor: ['push-api-server-image']
    secretEnv:
      [
        'SERVICE_ACCOUNT_EMAIL',
        'MYSQL_DBNAME',
        'MYSQL_USER',
        'MYSQL_PASS',
        'MYSQL_HOST',
        'MYSQL_PORT',
        'SERVER_PORT',
        'JWT_TOKEN_KEY',
        'CLIENT_ORIGIN',
        'APP_ENV',
        'TZ',
      ]
availableSecrets:
  secretManager:
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/SERVICE_ACCOUNT_EMAIL/versions/1'
      env: SERVICE_ACCOUNT_EMAIL
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/MYSQL_DBNAME/versions/1'
      env: MYSQL_DBNAME
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/MYSQL_USER/versions/1'
      env: MYSQL_USER
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/MYSQL_PASS/versions/1'
      env: MYSQL_PASS
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/MYSQL_HOST/versions/1'
      env: MYSQL_HOST
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/MYSQL_PORT/versions/1'
      env: MYSQL_PORT
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/SERVER_PORT/versions/1'
      env: SERVER_PORT
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/JWT_TOKEN_KEY/versions/1'
      env: JWT_TOKEN_KEY
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/CLIENT_ORIGIN/versions/1'
      env: CLIENT_ORIGIN
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/APP_ENV/versions/1'
      env: APP_ENV
    - versionName: 'projects/${PROJECT_NUMBER}/secrets/TZ/versions/1'
      env: TZ
